#!/bin/bash
# Ultimate package-lock.json Conflict Fixer v2.0 (Nov 2025 Edition)
# Usage: ./fix-lock.sh [regen|manual|yarn] [--dry-run]
# Author: Grok-Enhanced Workflow

set -euo pipefail  # Strict mode: Exit on error, undefined vars, pipe fails

# Config Vars (Customize Here)
PROJECT_ROOT="${PWD}"
BACKUP_SUFFIX="$(date +%Y%m%d_%H%M%S)"
NPM_VERSION_MIN="10.0.0"
DRY_RUN=false

# Colors for Output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${YELLOW}ğŸš€ Starting Ultimate Lockfile Fixer...${NC}"

# Function: Check Prerequisites
check_prereqs() {
    echo -e "${YELLOW}ğŸ” Checking Environment...${NC}"
    if ! command -v git &> /dev/null; then
        echo -e "${RED}âŒ Git not found. Install it first.${NC}"
        exit 1
    fi
    if ! command -v npm &> /dev/null; then
        echo -e "${RED}âŒ npm not found. Install Node.js/npm.${NC}"
        exit 1
    fi
    local npm_ver=$(npm --version)
    if [[ $(echo -e "$npm_ver\n$NPM_VERSION_MIN" | sort -V | head -n1) != "$NPM_VERSION_MIN" ]]; then
        echo -e "${YELLOW}âš ï¸  npm $npm_ver detected (min: $NPM_VERSION_MIN). Proceeding, but update recommended.${NC}"
    fi
    if [[ ! -f "package.json" ]]; then
        echo -e "${RED}âŒ No package.json found. Are you in the project root?${NC}"
        exit 1
    fi
    if ! git rev-parse --git-dir > /dev/null 2>&1; then
        echo -e "${RED}âŒ Not a Git repo. Initialize with 'git init'.${NC}"
        exit 1
    fi
    echo -e "${GREEN}âœ… Prereqs Passed!${NC}"
}

# Function: Backup Files
backup_files() {
    echo -e "${YELLOW}ğŸ’¾ Backing Up...${NC}"
    if [[ -f "package-lock.json" ]]; then
        cp package-lock.json "package-lock.backup-$BACKUP_SUFFIX.json"
        echo -e "${GREEN}âœ… Backed up package-lock.json${NC}"
    fi
    if [[ -f "package.json" ]]; then
        cp package.json "package.backup-$BACKUP_SUFFIX.json"
        echo -e "${GREEN}âœ… Backed up package.json${NC}"
    fi
    git stash push -m "Auto-backup pre-fix-$BACKUP_SUFFIX" || true  # Ignore if clean
}

# Function: Resolve package.json Conflicts (Interactive)
resolve_package_json() {
    echo -e "${YELLOW}ğŸ“ Resolving package.json Conflicts...${NC}"
    if grep -q '<<<<<<<' package.json; then
        echo -e "${YELLOW}âš ï¸  Conflicts detected. Opening in editor (VS Code assumed).${NC}"
        code package.json  # Or nano/vim
        echo -e "${YELLOW}Edit manually, save, then press Enter to continue.${NC}"
        read -r
        git add package.json
    else
        echo -e "${GREEN}âœ… No package.json conflicts.${NC}"
    fi
}

# Function: Nuke & Regen (Main Magic)
regen_lock() {
    echo -e "${YELLOW}ğŸ§¹ Cleaning & Regenerating...${NC}"
    rm -f package-lock.json node_modules/.package-lock.json  # Hidden too
    rm -rf node_modules
    if $DRY_RUN; then
        echo -e "${YELLOW}[DRY RUN] Would run: npm install${NC}"
    else
        npm install --package-lock-only  # Lock-only if no package.json changes
        echo -e "${GREEN}âœ… Lockfile Regenerated (v3)!${NC}"
    fi
}

# Function: Verify (Thorough Audit)
verify_fix() {
    echo -e "${YELLOW}ğŸ”¬ Verifying...${NC}"
    if ! $DRY_RUN; then
        npm ci --dry-run || { echo -e "${RED}âŒ ci dry-run failed.${NC}"; exit 1; }
        npm ls --depth=0 | head -20  # Sample output
        if grep -q 'UNMET DEPENDENCY' node_modules/.package-lock.json 2>/dev/null; then
            echo -e "${RED}âŒ Hidden lockfile issues.${NC}"
            rm -f node_modules/.package-lock.json
            npm install
        fi
        npm audit --audit-level=moderate
        echo -e "${GREEN}âœ… Verification Passed!${NC}"
    fi
}

# Function: Commit & Push
commit_fix() {
    echo -e "${YELLOW}ğŸ’¾ Committing...${NC}"
    git add package-lock.json package.json
    git commit -m "chore: auto-resolve lockfile conflicts via npm regen [skip ci]" || true
    echo -e "${GREEN}âœ… Committed. Push manually: git push${NC}"
}

# Function: Yarn Fallback (Alternative)
yarn_fallback() {
    echo -e "${YELLOW}ğŸ§¶ Switching to Yarn (if installed)...${NC}"
    if command -v yarn &> /dev/null; then
        rm -f yarn.lock
        yarn install
        echo -e "${GREEN}âœ… Yarn lock generated.${NC}"
    else
        echo -e "${RED}âŒ Yarn not found. Install via npm i -g yarn.${NC}"
    fi
}

# Main Execution
check_prereqs
backup_files
resolve_package_json

MODE="${1:-regen}"
case $MODE in
    regen)
        regen_lock
        ;;
    manual)
        echo -e "${YELLOW}ğŸ› ï¸ Manual Mode: Edit package-lock.json, then run verify.${NC}"
        code package-lock.json
        read -r  # Pause
        ;;
    yarn)
        yarn_fallback
        ;;
    *)
        echo -e "${RED}âŒ Invalid mode: regen|manual|yarn${NC}"
        exit 1
        ;;
esac

verify_fix
commit_fix

echo -e "${GREEN}ğŸ‰ Fix Complete! Restore backup if needed: mv package-lock.backup-*.json package-lock.json${NC}"